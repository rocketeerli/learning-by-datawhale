第九天

图像风格迁移；图像分类案例1；图像分类案例2

## 图像风格迁移

使用卷积神经网络自动将某图像中的样式应用在另一图像之上，即样式迁移。

![迁移学习流程](https://img-blog.csdnimg.cn/20200717214034994.png)

### 预处理函数和后处理函数

预处理函数 preprocess 对输入图像在RGB三个通道分别做标准化，并将结果变换成卷积神经网络接受的输入格式。

后处理函数 postprocess 则将输出图像中的像素值还原回标准化之前的值。

### 利用 VGG 抽取图像特征

VGG网络使用了5个卷积块。实验中，我们选择第四卷积块的最后一个卷积层作为内容层，以及每个卷积块的第一个卷积层作为样式层。

给定输入X，如果简单调用前向计算net(X)，只能获得最后一层的输出。由于我们还需要中间层的输出，因此这里我们逐层计算，并保留内容层和样式层的输出。

因为在训练时无须改变预训练的VGG的模型参数，所以我们可以在训练开始之前就提取出内容图像的内容特征，以及样式图像的样式特征。

### 损失函数

迁移的损失函数由内容损失、样式损失和总变差损失3部分组成。

* 内容损失

与线性回归中的损失函数类似，内容损失通过平方误差函数衡量合成图像与内容图像在内容特征上的差异。

* 样式损失

样式损失也一样通过平方误差函数衡量合成图像与样式图像在样式上的差异。

计算特征图的格拉姆矩阵，来表达样式层输出的样式。

当 hw 的值较大时，格拉姆矩阵中的元素容易出现较大的值。此外，格拉姆矩阵的高和宽皆为通道数 c。

为了让样式损失不受这些值的大小影响，需要将格拉姆矩阵除以了矩阵中元素的个数 chw。

样式损失的平方误差函数的两个格拉姆矩阵输入分别基于合成图像与样式图像的样式层输出。

* 总变差损失

有时候，我们学到的合成图像里面有大量高频噪点，即有特别亮或者特别暗的颗粒像素。一种常用的降噪方法是总变差降噪，能够尽可能使邻近的像素值相似。

* 总结

样式迁移的损失函数即内容损失、样式损失和总变差损失的加权和。通过调节这些权值超参数，我们可以权衡合成图像在保留内容、迁移样式以及降噪三方面的相对重要性。

### 总结

1. 样式迁移常用的损失函数由3部分组成：内容损失使合成图像与内容图像在内容特征上接近，样式损失令合成图像与样式图像在样式特征上接近，而总变差损失则有助于减少合成图像中的噪点。

2. 可以通过预训练的卷积神经网络来抽取图像的特征，并通过最小化损失函数来不断更新合成图像。

3. 用格拉姆矩阵表达样式层输出的样式。

## 图像分类案例1（CIFAR-10）

**ImageFolder会维护一部分可接受的图像文件类型，对于不可接受的文件类型会直接忽略掉**。
